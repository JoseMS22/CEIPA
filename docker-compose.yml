#version: "3.9"

services:
  db:
    image: mysql:8.0
    container_name: ceipa_db
    restart: unless-stopped
    env_file:
      - ./infra/db.env      # ahora tendrÃ¡ variables de MySQL
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$MYSQL_USER -p$MYSQL_PASSWORD || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10


  backend:
    build: ./backend
    container_name: ceipa_backend
    restart: unless-stopped
    env_file:
      - ./backend/.env
    depends_on:
      db:
        condition: service_healthy
    environment:
      - PYTHONPATH=/app
    command: >
      sh -c "alembic upgrade head &&
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --proxy-headers"
    #volumes:
    #  - ./backend/alembic/versions:/app/alembic/versions


  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ceipa_frontend
    restart: unless-stopped
    env_file:
      - ./frontend/.env.production
    depends_on:
      - backend
    command: "npm run start"
    volumes: []

volumes:
  db_data:
